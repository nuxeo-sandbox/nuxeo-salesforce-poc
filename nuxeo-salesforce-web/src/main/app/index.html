<!doctype html>

<html lang="">

<head>
  <meta charset="utf-8">
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="generator" content="Polymer Starter Kit" />
  <title>Nuxeo Picker</title>
  <!-- Place favicon.ico in the `app/` directory -->

  <!-- Chrome for Android theme color -->
  <meta name="theme-color" content="#303F9F">

  <!-- Web Application Manifest -->
  <link rel="manifest" href="manifest.json">

  <!-- Tile color for Win8 -->
  <meta name="msapplication-TileColor" content="#3372DF">

  <!-- Add to homescreen for Chrome on Android -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PSK">
  <link rel="icon" sizes="192x192" href="images/touch/chrome-touch-icon-192x192.png">

  <!-- Add to homescreen for Safari on iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Polymer Starter Kit">
  <link rel="apple-touch-icon" href="images/touch/apple-touch-icon.png">

  <!-- Tile icon for Win8 (144x144) -->
  <meta name="msapplication-TileImage" content="images/touch/ms-touch-icon-144x144-precomposed.png">

  <!-- build:css styles/main.css -->
  <link rel="stylesheet" href="styles/main.css">
  <!-- endbuild-->

  <!-- build:js bower_components/webcomponentsjs/webcomponents-lite.min.js -->
  <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <!-- endbuild -->

  <!-- will be replaced with elements/elements.vulcanized.html -->
  <link rel="import" href="elements/elements.html">
  <!-- endreplace-->
</head>

<body unresolved class="fullbleed layout vertical">
  <span id="browser-sync-binding"></span>
  <template is="dom-bind" id="app">

    <nx-connection id="nx" url="/nuxeo"></nx-connection>

    <paper-drawer-panel id="paperDrawerPanel" drawer-width="300px" right-drawer>
      <paper-header-panel drawer mode="seam">

        <!-- Drawer Content -->
        <template is="dom-if" if="[[selected]]">
          <nuxeo-metadata doc="[[selected]]"></nuxeo-metadata>
        </template>

      </paper-header-panel>
      <paper-header-panel main mode="waterfall">

        <!-- Main Toolbar -->
        <paper-toolbar id="mainToolbar">
          <div class="horizontal layout center">
            <paper-icon-button id="icon" icon="search" on-tap="toggleSearch"></paper-icon-button>
            <paper-input id="search" hidden type="search" bind-value="{{searchTerm}}" on-blur="toggleSearch" autocomplete="off" placeholder="Search"></paper-input>
          </div>
          <span class="flex"></span>

          <!-- Toolbar icons -->
          <template is="dom-if" if="[[selected]]">
            <paper-icon-button id="paperToggle" icon="info" paper-drawer-toggle></paper-icon-button>
          </template>

        </paper-toolbar>

        <!-- Main Content -->
        <div class="content">
          <nuxeo-listing search-term="{{searchTerm}}" selected="{{selected}}"></nuxeo-listing>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>

    <div id="leaddetails"></div>

  </template>

  <!-- build:js scripts/app.js -->
  <script src="scripts/app.js"></script>
  <!-- endbuild-->
  <!-- build:js scripts/vendor/json2.js -->
  <script src="scripts/vendor/json2.js"></script>
  <!-- endbuild-->
  <!-- build:js scripts/vendor/canvas-all.js -->
  <script src="https://na34.salesforce.com/canvas/sdk/js/34.0/canvas-all.js"></script>
  <!-- endbuild-->

  <script src="../bower_components/jquery/dist/jquery.min.js"></script>



  <!-- Salesforce Script -->
  <div>access_token = <span id="oauth"></span></div>
  <div><a id="login" href="#">Login</a>
    <br>
  </div>

  <script src="scripts/app.js"></script>
  <script src="scripts/vendor/json2.js"></script>
  <script src="https://na34.salesforce.com/canvas/sdk/js/34.0/canvas-all.js"></script>
  <script src="../bower_components/jquery/dist/jquery.min.js"></script>
  <script>
    Sfdc.canvas(function() {
      var loggedIn = Sfdc.canvas.oauth.loggedin();
      if (loggedIn) {
        sessionStorage.setItem("client",JSON.stringify(Sfdc.canvas.oauth.client()));
        Sfdc.canvas.client.ctx(callback, Sfdc.canvas.oauth.client())
      }
      window.onload = loginHandler;
    })
    function loginHandler(e) {
      var uri;
      if (!Sfdc.canvas.oauth.loggedin()) {
        uri = Sfdc.canvas.oauth.loginUrl();
        Sfdc.canvas.oauth.login({
          uri: uri,
          params: {
            response_type: "token",
            client_id: "3MVG9KI2HHAq33Rw3X7mQauk5.B.uuz_9Q8V8spV9ydsDyov4MaFEvyrajf2BKGgedc.W4WXaupu0q2dkEA_y",
            redirect_uri: encodeURIComponent("https://172.28.255.143:8443/nuxeo/picker/callback/callback.html")
          }
        });
      } else {
        Sfdc.canvas.oauth.logout();
      }
      return false;
    }
    function callback(ctx) {
      if (ctx.status !== 200) {
        alert("Error: " + ctx.status);
        return;
      }
      var opportunity = {};
      var opId = ctx.payload.environment.record.Id;
      var queryUrl = ctx.payload.links.queryUrl;
      var soqlQuery = "SELECT Name, id from Opportunity where id='"+opId+"'";
      Sfdc.canvas.client.ajax(queryUrl + "?q=" + soqlQuery, {
        client: JSON.parse(sessionStorage.getItem("client")),
        method: 'GET',
        contentType: "application/json",
        success : function(response){
          opportunity = response.payload;
          alert("Opportunity : "+JSON.stringify(opportunity));
        }
      })
    };
  </script>
</body>

</html>
