<dom-module id="nuxeo-contentview" assetpath="nuxeo-contentview/">
  <template>
    <nx-connection id="nx"></nx-connection>
    <nx-operation id="QueryAudit" op="Salesforce.AuditProvider" params="{{params}}" response="{{response}}" input="[[currentParent.path]]"></nx-operation>
    <paper-material>
      <sweet-material-table id="table" title="Audit" data="[[response.entries]]" columns="[[columns]]" available-columns="[[availableColumns]]" start="[[response.currentPageIndex]]" per-page="[[response.currentPageSize]]" sort-column="Username" sort-direction="descending" total="[[response.resultsCount]]" actions="[[actions]]" global-actions="[[globalActions]]">
      </sweet-material-table>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: 'nuxeo-contentview',
      properties: {
        params: {
          type: Object,
          value: {}
        },
        currentParent: {
          type: Object
        },
        columns: {
          type: Array,
          value: function () {
            return [
              {key: 'principalName', title: 'Username'},
              {key: 'eventDate', title: 'Event Date'},
              {key: 'eventId', title: 'Category'},
              {key: 'docPath', title: 'Document'},
              {key: 'docType', title: 'Document Type'}
            ]
          }
        },
        availableColumns: {
          type: Array,
          value: function () {
            return [
              {key: 'principalName', title: 'Username'},
              {key: 'eventDate', title: 'Event Date'},
              {key: 'eventId', title: 'Category'},
              {key: 'docPath', title: 'Document'},
              {key: 'docType', title: 'Document Type'}
            ]
          }
        },
        globalActions: {
          type: Array,
          value: function () {
            return [
              {
                name: 'refresh',
                title: 'Refresh'
              }
            ];
          }
        },
        response: {
          type: Object,
          notify : true
        }
      },
      observers: [
        '_updateQuery(currentParent)'
      ],
      _updateQuery: function () {
        this.params.providerName="AUDIT_BROWSER";
        this.params.pageSize=0;
        this.params.namedQueryParams = {};
        this.params.namedQueryParams["bas:eventIds"] = "download,documentCreated,documentModified";
        this.$.QueryAudit.execute();
      },
      ready: function () {
        this.$.table.addEventListener('action', this._onAction.bind(this));
      },
      _onAction: function (event) {
        if (event.detail.name === 'refresh') {
          this._updateQuery();
          this.$.table.addEventListener('action', this._onAction.bind(this));
        }
      }
    });
  </script>
</dom-module>
