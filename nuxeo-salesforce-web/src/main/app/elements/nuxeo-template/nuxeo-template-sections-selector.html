<dom-module id="nuxeo-template-sections-selector">
  <style>
    paper-toggle-button {
      padding: 2%;
      --paper-toggle-button-label-color: black;
      --paper-toggle-button-checked-bar-color: green;
      --paper-toggle-button-checked-button-color: green;
    }

    h1 {
      color: black;
    }

    p {
      color: black;
    }
    .centered {
      display: block;
      margin: auto;
    }

  </style>
  <template>
    <nuxeo-connection id="nx"></nuxeo-connection>
    <nuxeo-resource id="oauth2directory" path="/oauth2directory/salesforce" response="{{result}}" auto="" success="{{success}}" error="{{error}}"></nuxeo-resource>
    <nuxeo-salesforce-connection id="sfc" callback="[[result.userAuthorizationURL]]" clientid="[[result.clientId]]" sfobject="{{sfopportunity}}"></nuxeo-salesforce-connection>
    <nuxeo-salesforce-object id="sfa" callback="[[result.userAuthorizationURL]]" clientid="[[result.clientId]]" object-type="Account" object-id="{{sfopportunity.AccountId}}" sfobject="{{sfaccount}}"></nuxeo-salesforce-object>
    <nuxeo-salesforce-object id="sfu" callback="[[result.userAuthorizationURL]]" clientid="[[result.clientId]]" object-type="User" object-id="{{sfopportunity.OwnerId}}" sfobject="{{sfowner}}"></nuxeo-salesforce-object>
    <nuxeo-operation id="render" op="Conversion.CreateSowOp" response="{{_result}}" success="{{success}}" error="{{error}}"></nuxeo-operation>

    <template is="dom-if" if="[[_show_selection]]">
      <h1>Select the Sections to Include</h1>
      <template is="dom-repeat" items="[[sections]]">
        <paper-toggle-button checked="{{item.checked}}">{{item.name}}</paper-toggle-button>
      </template>
      <div class="buttons">
        <paper-button id="[[doc.uid]]" on-click="_render">Render</paper-button>
        <paper-button dialog-confirm>Cancel</paper-button>
      </div>
    </template>
    <template is="dom-if" if="[[_show_spinner]]">
      <h1>Rendering Template</h1>
      <paper-spinner active class="centered"></paper-spinner>
    </template>
    <template is="dom-if" if="[[_show_result]]">
      <h1>Rendering Completed</h1>
      <nuxeo-template-document doc=[[_result]]></nuxeo-template-document>
      <p>This document has been saved in this opportunity</p>
      <div class="buttons">
        <paper-button dialog-confirm>Close</paper-button>
      </div>
    </template>
    <template is="dom-if" if="[[_show_error]]">
      <p>An Error Occured</p>
      <div class="buttons">
        <paper-button dialog-confirm>Close</paper-button>
      </div>
    </template>
  </template>
  <script>
    Polymer({
      is: 'nuxeo-template-sections-selector',
      properties: {
        doc: {
          type: Object,
          notify: true
        },
        sections: {
          type: Array,
          notify: true
        },
        _show_spinner: {
          type: Boolean,
          value: false,
          notify: true
        },
        _show_selection: {
          type: Boolean,
          value: true,
          notify: true
        },
        _show_result: {
          type: Boolean,
          value: false,
          notify: true
        },
        _show_error: {
          type: Boolean,
          value: false,
          notify: true
        },
        _result: {
          type: Object,
          notify: true,
          value: null
        }
      },

      observers: [
        '_updateSections(doc)', '_updateResult(_result)', '_displayError(error)'
      ],

      ready: function() {},

      _updateSections() {
        var sectionNames = this.doc.properties['sections:sections'];
        var sectionsTmp = [];
        for (var i = 0; i < sectionNames.length; i++) {
          sectionsTmp.push({name: sectionNames[i], checked: false});
        }
        this.sections = sectionsTmp;
      },

      _updateResult() {
        if (this._result === undefined) {
           this._displayError();
        } else if (this._result !== undefined && this._result !== null) {
           this._show_spinner = false;
           this._show_result = true;
        }
      },

      _displayError: function() {
        this._show_selection = false;
        this._show_spinner = false;
        this._show_result = false;
        this._show_error = true;
      },

      _render: function(e) {
        var id = e.currentTarget.id;
        this.$.render.input = id;

        var checkedSections = [];
        for (var i=0;i<this.sections.length;i++) {
           var section = this.sections[i];
           if (section.checked) checkedSections.push(section.name);
        }

        this.$.render.params = {
          opportunity: (this.sfopportunity !== undefined ? this.sfopportunity: {}),
          account: (this.sfaccount !== undefined ? this.sfaccount: {}),
          owner: (this.sfowner !== undefined ? this.sfowner: {}),
          sections: checkedSections
        };
        this.$.render.execute();
        this._show_spinner = true;
        this._show_selection = false;
      }
    });
  </script>
</dom-module>
