<?xml version="1.0"?>
<component name="org.nuxeo.salesforce.automation.contrib">
  <extension target="org.nuxeo.ecm.core.operation.OperationServiceComponent"
             point="operations">
    <operation
            class="org.nuxeo.salesforce.SalesforceAuditProvider" />
  </extension>
  <extension
          target="org.nuxeo.automation.scripting.internals.AutomationScriptingComponent"
          point="operation">
    <scriptedOperation id="javascript.FetchSFObject">
      <inputType>void</inputType>
      <outputType>void</outputType>
      <category>javascript</category>
      <script>
        <![CDATA[function run(input, params) {
          var sfobject = JSON.parse(params.sfObject);
          var docs = Repository.Query(null, {
            'query': "SELECT * FROM Document WHERE ecm:currentLifeCycleState != 'deleted' AND sf:objectid = '" + sfobject.Id + "' AND ecm:isCheckedInVersion = 0 AND ecm:mixinType != 'HiddenInNavigation'",
          });
          if (docs.length>0) {
            return Repository.GetDocument(null, {
              'value': docs[0].id
            });
          } else {
            var workspaces = Repository.GetDocument(null, {
                "value" : "/default-domain/workspaces"
            });
            var newSFobject = Document.Create(workspaces, {
                  "type" : "Workspace",
                  "name" : sfobject.Name,
                  "properties" : {
                      "dc:title" : sfobject.Name,
                       "sf:objectid" : sfobject.Id
                  }
            });
            return newSFobject;
        }}]]>
      </script>
    </scriptedOperation>
    <scriptedOperation id="javascript.SFGetChildren">
      <inputType>document</inputType>
      <outputType>documents</outputType>
      <category>javascript</category>
      <script>
        <![CDATA[function run(input, params) {
            return Document.GetChildren(input, {});
        }]]>
      </script>
    </scriptedOperation>
  </extension>
  <extension target="org.nuxeo.ecm.automation.server.AutomationServer"
             point="bindings">
    <!-- Give access to Audit logs -->
    <binding name="Salesforce.AuditProvider">
      <!-- Temporarily removed 'secure' option: TODO: NXP-18150 -->
      <!--<secure>true</secure>-->
      <groups>administrators,members</groups>
    </binding>
  </extension>
</component>
